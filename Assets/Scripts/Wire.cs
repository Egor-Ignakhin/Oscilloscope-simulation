using System.Collections.Generic;

using OscilloscopeSimulation.InteractableObjects;

using UnityEngine;
namespace OscilloscopeSimulation
{
    /// <summary>
    /// Провод, соединяющий сокеты установки
    /// </summary>
    internal sealed class Wire : MonoBehaviour
    {
        /// <summary>
        /// Визуальная составляющая провода
        /// </summary>
        [SerializeField] private LineRenderer lineRenderer;
        
        public WireSocketInteractable Connector_1 { get; private set; }
        public WireSocketInteractable Connector_2 { get; private set; }

        /// <summary>
        /// Пользователь взаимодействует с проводом?
        /// </summary>
        public bool UserInteractingWithTheWire { get; private set; }

        private PlayerInteractive playerInteractive;

        /// <summary>
        /// Метод, вызываемый перед первым вызовом метода Update
        /// </summary>
        private void Start()
        {
            //Устанавливаем необходимое кол-во вершин провода
            lineRenderer.positionCount = 2;

            //Находим на сцене оператор взаимодействия
            playerInteractive = FindObjectOfType<PlayerInteractive>();
        }

        /// <summary>
        /// Метод установки позиции коннектора
        /// </summary>
        /// <param name="positionForWireConnector"></param>
        internal void SetConnectorPosition(WireSocketInteractable positionForWireConnector)
        {
            //Если коннектор 1 не подключен
            if (!Connector_1)
            {
                //Коннектор 1 подключается к сокету
                Connector_1 = positionForWireConnector;

                //Провод входит в активное состояния взаимодействия
                UserInteractingWithTheWire = true;
            }
            else
            {
                //Коннектор 1 подключается к сокету
                Connector_2 = positionForWireConnector;

                //Провод выходит из активного состояния взаимодействия
                UserInteractingWithTheWire = false;
            }
        }

        /// <summary>
        /// Метод переподключения провода
        /// </summary>
        private void Reconnect()
        {
            //Если коннектор 1 не подключен
            if (!Connector_1)
            {
                //Заставляем вершины провода переместиться в начало мировых координат
                lineRenderer.SetPositions(new Vector3[]{Vector3.zero, Vector3.zero});

                //Выходим из метода
                return;
            }

            //Если пользователь взаимодействует с проводом
            if (UserInteractingWithTheWire)
            {
                //Устанавливаем вершины:
                // - коннетор 1
                // - координаты точки соприкосновения луча оператора с физ. объектами сцены
                lineRenderer.SetPositions(
                    new Vector3[] { Connector_1.GetPositionForWireConnector(), playerInteractive.LastHitPoint });
            }
            else
            {
                //Устанавливаем вершины:
                // - коннетор 1
                // - коннетор 2
                lineRenderer.SetPositions(
                    new Vector3[] { Connector_1.GetPositionForWireConnector(), Connector_2.GetPositionForWireConnector() });
            }
        }

        private void LateUpdate()
        {
            Reconnect();
        }

        /// <summary>
        /// Метод полного отключения провода от сокетов
        /// </summary>
        internal void Disconnect()
        {
            Connector_1 = null;
            Connector_2 = null;
            UserInteractingWithTheWire = false;
        }

        /// <summary>
        /// Метод частичного отключения провода от сокета. Параметр - сокет
        /// </summary>
        /// <param name="point"></param>
        internal void DisconnectFromPoint(WireSocketInteractable point)
        {
            //Если коннетор 1 - это сокет
            if (Connector_1.Equals(point))
            {
                // Обнуляем коннектор 1
                Connector_1 = null;
            }
            else
            {
                // Обнуляем коннектор 2
                Connector_2 = null;
            }

            //Если коннетор 1 - пуст
            if (Connector_1 == null)
            {
                //Переназначаем коннектор 2 на коннектор 1
                Connector_1 = Connector_2;
                //Коннетор 2 очищаем
                Connector_2 = null;
            }

            //Теперь пользователь взаимодействует с проводом
            UserInteractingWithTheWire = true;
        }        
    }
}